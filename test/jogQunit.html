<!--
  ~ The MIT License
  ~
  ~ Copyright (c) 2011 Ken Arnold
  ~
  ~ Permission is hereby granted, free of charge, to any person obtaining a copy
  ~ of this software and associated documentation files (the "Software"), to deal
  ~ in the Software without restriction, including without limitation the rights
  ~ to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
  ~ copies of the Software, and to permit persons to whom the Software is
  ~ furnished to do so, subject to the following conditions:
  ~
  ~ The above copyright notice and this permission notice shall be included in
  ~ all copies or substantial portions of the Software.
  ~
  ~ THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  ~ IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  ~ FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
  ~ AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  ~ LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
  ~ OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
  ~ THE SOFTWARE.
  -->

<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <title>Jog Quint tests</title>

    <script src="http://code.jquery.com/jquery-latest.js"
            type="text/javascript"></script>

    <link rel="stylesheet" href="http://code.jquery.com/qunit/git/qunit.css"
          type="text/css" media="screen"/>
    <script type="text/javascript"
            src="http://code.jquery.com/qunit/git/qunit.js"></script>

    <script type="text/javascript" src="../src/jog.js"></script>
</head>

<script>
var runTests = function() {
    // without this QUnit reorders tests as it sees fit
    QUnit.config.reorder = false;

    var levels = $.jog.levels;
    var baseHandlers = $.jog.baseHandlers;
    var timeSource;
    var mockHandlers = [];

    function TimeSource() {
        var count = 0;
        this.nextTime = function() {
            return (count++).toPrecision(4);
        };
        this.reset = function() {
            count = 0;
        }
    }

    function newMockHandler(suffix) {
        if (suffix) {
            suffix = '-' + suffix;
        } else {
            suffix = '';
        }
        var handler = $.jog.newHandler("mockHandler" + suffix, {
            publish: function(area, levelNum, levelName, when, message) {
                this.ensureSetup();
                this.logHistory.push(
                        [area, levelNum, levelName, when, message]);
            },
            alert: function(area, levelNum, levelName, when, message) {
                this.ensureSetup();
                this.alertHistory.push(
                        [area, levelNum, levelName, when, message]);
            },
            destroy: function() {
                this.ensureSetup();
                this.destroyed = true;
            },
            reset: function() {
                this.logHistory = [];
                this.alertHistory = [];
                this.destroyed = false;
            },
            testLog: function(willAdd, area, level, message) {
                this.ensureSetup();
                var oldLen = this.logHistory.length;
                this.markCount();
                $.jog(area).log(level, message);
                var newLen = this.logHistory.length;
                var msg = ': ' + message;
                if (!willAdd) {
                    this.checkChange(0, msg);
                } else {
                    this.checkChange(1, msg);
                    if (newLen != oldLen + 1) return;
                    var latest = this.logHistory[oldLen];
                    equal(latest[0], area, message);
                    equal(latest[1], level, message);
                    equal(latest[4], message, message);
                }
            },
            ensureSetup: function() {
                if (!this.logHistory) this.reset();
            },
            markCount: function() {
                this.markedCount = this.logHistory.length;
            },
            checkChange: function(change, message) {
                equal(this.markedCount + change, this.logHistory.length,
                        message);
            },
            toString: function() {
                var lines = [this._handlerId];
                $.each(this.logHistory, function(index, value) {
                    lines.push(value.toString());
                });
                return lines.join('\n');
            }
        });
        mockHandlers.push(handler);
        return handler;
    }

    function initMocks() {
        mockHandlers = [];

        var rootArea = $.jog();
        rootArea.handlers(baseHandlers.console);
        rootArea.level(levels.Info);
        rootArea.alertLevel(levels.Alert);

        timeSource = new TimeSource();
        rootArea.toTimeString = function() {
            return timeSource.nextTime();
        };

    }

    function resetMocks() {
        for (var i = 0; i < mockHandlers.length; i++) {
            mockHandlers[i].reset();
        }
        timeSource.reset();
    }

    test("basic expectations", function() {
        expect(5);
        ok($.jog, "$.jog exists");
        ok($.jog(), "$.jog() returns an object");
        ok($.jog.levels, "$.jog().levels is an object");
        ok($.jog.baseHandlers, "$.jog().baseHandlers is an object");
        ok($.jog.newHandler, "$.jog().baseHandlers is a function");
    });

    test("test setup", function() {
        equal($.jog().level(), levels.Info);
        var handlers = $.jog().handlers();
        deepEqual(handlers, [baseHandlers.console]);
        ok($.jog().toTimeString(new Date(0)).match(/-?\d\d:00:00/));
    });

    test("test the mock handler", function() {
        initMocks();
        var mockHandler = newMockHandler();
        var msg1 = "Message 1";
        $.jog().handlers(mockHandler);
        equal(mockHandler.name, "mockHandler");
        $.jog().handlers(mockHandler);
        var handlers = $.jog().handlers();
        ok(handlers[0] === mockHandler);
        mockHandler.testLog(true, 'x.y.z', levels.Info, msg1);
        mockHandler.testLog(false, 'x.y.z', levels.Debug, msg1);
    });

    test("test basic filtering", function() {
        initMocks();
        var mockHandler = newMockHandler();
        $.jog().handlers(mockHandler);
        var area = $.jog('filter');
        var rootMsg = 'root @ ' + $.jog.levelName(levels.Info);
        for (var filterAt = levels.Fine; filterAt <= levels.Off; filterAt++) {
            area.level(filterAt);
            var filterName = $.jog.levelName(filterAt);
            equals(area.level(), filterAt, "filter level = " + filterName);
            var filterMsg = "filter @ " + filterName;
            for (var logAt = levels.Fine; logAt < levels.Off; logAt++) {
                var logMsg = "log @ " + $.jog.levelName(logAt);
                // Test that level filtering at the area works
                mockHandler.testLog(logAt >= filterAt, 'filter', logAt,
                        filterMsg + ", " + logMsg);
                // test that the level filtering at the root is unaffected
                mockHandler.testLog(logAt >= levels.Info, '', logAt,
                        rootMsg + ', ' + logMsg);
            }
        }
    });

    test("test handler inheritence", function() {
        initMocks();

        /*
         * First we try out what happens if we have a unique handler at each
         * area in a hierarchy.
         */
        // One handler to add at each area
        var h = newMockHandler('1');
        var hX = newMockHandler('2');
        var hXY = newMockHandler('3');

        // Set one handler at each area
        var area = $.jog();
        var areaX = $.jog('x');
        var areaXY = $.jog('x.y');
        area.handlers(h);
        areaX.handlers(hX);
        areaXY.handlers(hXY);

        // verify settings
        var handlers = area.handlers;
        deepEqual(area.handlers(), [h]);
        deepEqual(areaX.handlers(), [hX]);
        deepEqual(areaXY.handlers(), [hXY]);

        function logMessages(assumeEquals) {
            // Log one message at each area
            area.info('{root}');
            areaX.info('x');
            areaXY.info('x.y');

            if (assumeEquals) {
                // Verify the right number of messages at each area
                equals(h.logHistory.length, 3);
                equals(hX.logHistory.length, 2);
                equals(hXY.logHistory.length, 1);
            }
        }

        logMessages(true);

        // Remember what happened
        var hStr = h.toString();
        var hXStr = hX.toString();
        var hXYStr = hXY.toString();

        /*
         * Next we try what happens if we turn off inheritance of handlers.
         */
        resetMocks();

        areaX.useParentHandlers(false);
        logMessages();
        notEqual(h.toString(), hStr);
        equal(h.logHistory.length, 1);
        equal(hX.toString(), hXStr);
        equal(hXY.toString(), hXYStr);

        // put it back for the next test
        areaX.useParentHandlers(true);

        /*
         * Then we try out what happens if we have duplicate handlers in the
         * hierarchy, which should be the same as the first run.
         */
        resetMocks();

        // Set all handlers at each area (via both handlers() and addHandlers())
        area.handlers(h);
        areaX.handlers(hX);
        areaX.addHandlers(h);
        areaXY.handlers(h, hXY);
        areaXY.addHandlers(hX);

        // verify settings
        handlers = area.handlers;
        equal(area.handlers().length, 1);
        equal(areaX.handlers().length, 2);
        equal(areaXY.handlers().length, 3);

        logMessages(true);

        // verify the same things happened
        equal(h.toString(), hStr);
        equal(hX.toString(), hXStr);
        equal(hXY.toString(), hXYStr);

        /*
         * Finally we try what happens if we turn off inheritance of handlers
         * when there are duplicates, so it should not make a difference.
         */
        resetMocks(false);

        areaX.useParentHandlers(false);
        logMessages();
        equal(h.toString(), hStr);
        equal(hX.toString(), hXStr);
        equal(hXY.toString(), hXYStr);
    });

    test("derived method", function() {
        initMocks();
        var root = $.jog();
        var area = $.jog('derived');
        var h = newMockHandler();
        area.addHandlers(h);
        
        var derived = area.derive();

        equals(levels.Info, root.level());
        equals(undefined, area.level());
        equals(root.level(), derived.level());
        
        deepEqual(area.handlers(), [h]);
        equal(derived.handlers().length, 2);
    });
};

$(document).ready(runTests);
</script>

<body>

<h1 id="qunit-header">Jog Qunit Tests</h1>

<h2 id="qunit-banner"></h2>

<div id="qunit-testrunner-toolbar"></div>
<h2 id="qunit-userAgent"></h2>

<ol id="qunit-tests"></ol>
<div id="qunit-fixture">test markup, will be hidden</div>

</body>
</html>